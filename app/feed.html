<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community</title>
    <link rel='stylesheet' href='./css/nav.css' type='text/css'>
    <link rel='stylesheet' href='./css/main.css' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Leckerli+One" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src='./js/main.js'></script>
</head>
    <body>
        <div id='nav'>

        </div>
        <div id='pageHeading'>
            <p id='pageTitle'>Notice Board</p>
        </div>
        <div class='feedContainer flex flex-row'>
            <!-- Any side nav item can attach to this div -->
            <div class='leftNavbar'>

            </div>

            <!-- Container for the feed -->
            <div class='listContainer'>

                <!-- Only shows if there are no other items shoing  -->
                <div id='noItems' class='hidden'>
                    Woops! There are no items :(
                </div>

            </div>

        </div>

        <script>
            // The global variables that allow for caching of feed data.
            // Can be used to reference posts without another ajax request.
            let feedState = {

                // List of posts with all post data
                items: [],
                itemsObject: {},

                // List of items that the logged in user has voted on.
                // Exists for a check when loading each post to see if the user has voted on it.
                votedItems: {},

                // The active accordion. Used to control how many accordions are open.
                activeId: null,
            }

            // General function that can be used to implement a filter / tag
            // Modifies the URL, clears the feed, and reloads the feed only showing
            // posts that are within that category.
            function changeURL(tag){
                history.pushState(null, '', `/app/feed.html?tag=${tag}`);
                clearItems();

                // Sort based on upvotes
                feedState.items.sort(function(a, b) {
                        return b.voteCount - a.voteCount;
                }).forEach((item) => {
                    // Loop through the posts only loading those that are part of the category
                    // TODO render comment even if it is not within the tag
                    if (item.item_category === tag || item.item_category == 'Announcements') {
                        
                        // Add the post differently based on whether or not it is a comment
                        if (!item.childOf) {
                            addToUi(item)
                        } else {
                            addToUi(item, item.childOf)
                        }
                    }
                })
            }

            // General function that can simply be fed a category without changing the URL
            // Yes, this is very similar to changeURL... oh well :) 
            function renderUICategory(dept) {
                clearItems();
                feedState.items.sort(function(a, b) {
                        return b.voteCount - a.voteCount;
                }).forEach((item) => {
                    if(item.postCategory === dept || item.postCategory == 'Announcements'){
                        if (!item.childOf) {
                            addToUi(item)
                        } else {
                            addToUi(item, item.childOf)
                        }
                    }
                })
            }

            // Main function that is called on page load to fetch all of the posts
            // Gets items, loads them into feedState, gets the votes, and renders UI
            function getItems() {
                let loader;
                // Set up loader
                // Check to see if there is one already
                if (document.getElementById('loader')) {
                    loader = document.getElementById('loader')

                    // If so, unhide it
                    if (loader.classList.contains('hide')) {
                        loader.classList.remove('hide')
                    }
                } else {
                    // Create and show loader
                    let loader = document.createElement('img')
                        loader.src = './assets/91.svg'
                        loader.id = 'loader'
                        document.querySelector('.listContainer').appendChild(loader)
                }
            
                // Retrieves all of the posts
                $.ajax({
                    type: "GET",
                    url: '/api/get-items',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (msg) {
                        loader.classList.add('hide');
                        // This sets the feedState.items to be an array of post objects
                        feedState.items = msg;
                        // This sets the feedState.itemsObject to be an object of post objects
                        // Useful because then data can be accessed via feedState.itemsObject[id]
                        // for immediate access (rather than looping)
                        feedState.items.forEach((post) => {
                            feedState.itemsObject[post.postID] = {
                                postContent: post.postContent,
                                department: post.postCategory,
                                voteCount: post.voteCount,
                                downVoteCount: post.downVoteCount,
                                originalPosterId: post.originalPosterID,
                                childOf: post.childOf,
                                isMod: post.isMod,
                                modHasCommented: post.modHasCommented,
                            }
                        });
                    },
                    error: function (e) {
                        // Print if there's an error
                        console.log('failure')
                        console.log(e)
                    }
                // When we have all the posts, before we load everything, we want to grab the vote counts
                }).done((msg) => {

                    // Grab vote counts for the specific user logged in
                    $.ajax({
                        type: "GET",
                        url: '/api/get-votes',
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        data: {userId: Number(localStorage.getItem("ownerid"))},
                        success: function (msg) {

                            // Similar to grabbing the posts and loading them into feed state, this
                            // does the same thing but for vote count
                            msg.forEach((row) => {
                                feedState.votedItems[`p${row.p_id}`] = {vc_id: row.vc_id, up_or_down: row.up_or_down}
                            })
                        },
                        error: function (e) {
                            // Print if there's an error
                            console.log('failure')
                            console.log(e)
                        }
                    }).done((msg) => {
                        // Once all that is done, load the UI
                        // Check to see if there is a filter active in the URL
                        // First, grab all the query parameters
                        const urlParams = new URLSearchParams(window.location.search);

                        // If a tag is present, load only that tag
                        if(urlParams.get('tag')) {
                            clearItems()
                            renderUICategory(urlParams.get('tag'))
                            // Try to change document title
                            document.getElementById('pageTitle').innerHTML = urlParams.get('tag') + " Notice Board";

                            return;
                        }

                        // If there is no tag, sort the posts by upvotes and load all of the
                        // posts.
                        feedState.items.sort(function(a, b) {
                            return b.voteCount - a.voteCount;
                        }).forEach((post) => {
                            // If childOf is "Truthy" we want to load it as a comment
                            // Otherwise load it as a post
                            if (!post.childOf) {
                                addToUi(post)
                            } else {
                                addToUi(post, post.childOf)
                            }
                        })
                    })
                })
            }

            // General utility function that can just construct a basic item ID
            // Pretty sure this isn't used anymore, but might as well keep it just in case
            function makeItemObj() {
                let item_id = document.getElementById('item_id').value
                let renter_id = localStorage.getItem('ownerid')

                return {
                    item_id,
                    renter_id,
                }
            }

            // Function that handles the accordion functionality
            // Shows and hides the accordion, rotates chevron
            function rotate(id, child) {
                let targetToRotate = document.getElementById(`${id}`)
                let targetInnerDetails = document.getElementById(`${id}InnerDetails`)
                let chevron
                
                // The ID of the chevron changes if it's a post or a comment
                if (child) {
                    chevron = document.getElementById(`${id}Chevron-t`)
                } else {
                    chevron = document.getElementById(`${id}Chevron`)
                }
                
                // Toggle the necessary classes
                if (targetToRotate.classList.contains('active')) {
                    targetToRotate.classList.remove('active')
                    chevron.classList.remove('rotate')
                    targetInnerDetails.classList.add('hidden')
                } else {
                    targetToRotate.classList.add('active')
                    chevron.classList.add('rotate')
                    targetInnerDetails.classList.remove('hidden')
                }
            }

            // Utility function that resets the feed
            // Used to clear the container before re-rendering (like when a filter is applied)
            function clearItems(){
                document.querySelector('.listContainer').innerHTML = ''
            }

            // Function that loads every post and comment
            // Takes in the item itself as well as the ID of the post
            // the item is a child of (or is 0 if the item is a post)
            function addToUi(itemObj, childOf) {
                // Grab the ID of the user who has posted the item
                let posterId = itemObj.originalPosterID;
                let department = itemObj.postCategory;
                let postID = itemObj.postID;

                if(department == 'Announcements'){
                        // Grab the feed container
                    let listContainer = document.querySelector('.leftNavbar')
                    
                    // Make the item container
                    let itemContainer = generateFlexbox()
                    itemContainer.classList.add('item-container')
                    itemContainer.id = itemObj.postID
                

                    // Create the header of the post
                    let header = generateFlexbox()
                    header.innerHTML = itemObj.postContent
                    header.classList.add('item-header')

                    // Create the body of the post
                    let details = document.createElement('div')
                    details.classList.add('flex')
                    details.classList.add('flex-column')
                    details.classList.add('announcement-item-details')

                    // Create the hidden part of the post
                    let innerDetails = generateFlexbox()
                    innerDetails.classList.add('item-inner-details')
                    innerDetails.id = `${itemObj.postID}InnerDetails`
                    // Hide it
                    innerDetails.classList.add('hidden')

                    // Create the upvote arrow
                    let upArrow = generateFlexbox()
                        // This is the actual arrow icon
                        upArrow.innerHTML = `<img src='./assets/vote-icon.png' class='v-icon' id='up-v-icon' alt='upvote'/><div class='count' id='ua_${itemObj.postID}'>${itemObj.voteCount}</div>`
                        upArrow.classList.add('up-arrow')
                        upArrow.classList.add('arrow')

                        // Remember when we grabbed the items the user has voted on?
                        // This uses that data to check if this is one of those items
                        if (feedState.votedItems) {
                            let post_id = `p${itemObj.postID}`
                            // If the user has upvoted this before, add the voted class
                            if (feedState.votedItems[post_id]) {
                                if (feedState.votedItems[post_id].up_or_down === "up") {
                                    upArrow.classList.add('voted')
                                }
                            }
                        }

                        // Event listener that handles the upvote click
                        upArrow.addEventListener("click", () => {

                            // Get the current count
                            let currentCount = itemObj.voteCount
                            // We update may update the UI so the upvote count does not match the state
                            // If this is the case, trust the UI and not the state
                            if (Number(currentCount) !== Number(document.getElementById(`ua_${itemObj.postID}`).innerHTML)){
                                currentCount = document.getElementById(`ua_${itemObj.postID}`).innerHTML;
                            }
                            
                            // Create the item we are pushing to the server
                            let postDetails = {
                                postId: itemObj.postID,
                                userId: localStorage.getItem("ownerid"),
                                itemCount: currentCount,
                            }

                            // The arrow will have the "voted" class if the user has already voted
                            // If this is the class, remove the upvote
                            if (upArrow.classList.contains('voted')) {

                                // Reduce votecount by 1
                                $.ajax({
                                    type: "GET",
                                    url: '/api/upvote-reset',
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    data: postDetails,
                                    success: function (msg) {
                                        // On success, update UI
                                        upArrow.classList.remove('voted')
                                        document.getElementById(`ua_${itemObj.postID}`).innerHTML = msg.count;

                                        // Update state
                                        updateCount('up', 'del', itemObj.postID)
                                    },
                                    error: function (e) {
                                        console.log('failure')
                                        console.log(e)
                                    }
                                })
                            } else {
                                // If the user has not upvoted yet, send the update to the server
                                $.ajax({
                                    type: "GET",
                                    url: '/api/upvote',
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    data: postDetails,
                                    success: function (msg) {
                                        // On success, add points
                                        addEmployeePoints(1, posterId);

                                        // Update UI
                                        upArrow.classList.add('voted')
                                        document.getElementById(`ua_${itemObj.postID}`).innerHTML = msg.count;

                                        // Update state
                                        updateCount('up', 'add', itemObj.postID)
                                    },
                                    error: function (e) {
                                        console.log('failure')
                                        console.log(e)
                                    }
                                })
                            }
                        })

                    // Literally the exact smae as the upvote, just for downvoting.
                    // Maybe those functions should have been combined?
                    let downArrow = generateFlexbox()
                        downArrow.innerHTML = `<img src='./assets/vote-icon.png' class='v-icon' id='down-v-icon' alt='downvote'/><div class='count' id='da_${itemObj.postID}'>${itemObj.downVoteCount}</div>`
                        downArrow.classList.add('down-arrow')
                        downArrow.classList.add('arrow')

                        if (feedState.votedItems) {
                            let post_id = `p${itemObj.postID}`

                            if (feedState.votedItems[post_id]) {
                                if (feedState.votedItems[post_id].up_or_down === "down") {
                                    downArrow.classList.add('voted')
                                }
                            }
                        }

                    downArrow.addEventListener("click", () => {

                        let currentDownCount = itemObj.downVoteCount

                        if (Number(currentDownCount) !== Number(document.getElementById(`da_${itemObj.postID}`).innerHTML)){
                            currentDownCount = document.getElementById(`da_${itemObj.postID}`).innerHTML;
                        }

                        let postDetails = {
                            postId: itemObj.postID,
                            userId: 1,
                            itemCount: currentDownCount,
                        }

                        if (downArrow.classList.contains('voted')) {
                            $.ajax({
                                type: "GET",
                                url: '/api/downvote-reset',
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: postDetails,
                                success: function (msg) {
                                    downArrow.classList.remove('voted')
                                    document.getElementById(`da_${itemObj.postID}`).innerHTML = msg.count;
                                    updateCount('down', 'del', itemObj.postID)
                                },
                                error: function (e) {
                                    console.log('failure')
                                    console.log(e)
                                }
                            })
                        } else {
                            $.ajax({
                                type: "GET",
                                url: '/api/downvote',
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: postDetails,
                                success: function (msg) {
                                    downArrow.classList.add('voted')
                                    document.getElementById(`da_${itemObj.postID}`).innerHTML = msg.count;
                                    updateCount('down', 'add', itemObj.postID)
                                },
                                error: function (e) {
                                    console.log('failure')
                                    console.log(e)
                                }
                            })
                        }
                    })

                    // Create the home for the arrows
                    let arrowContainer = document.createElement('div')
                        arrowContainer.classList.add('arrowContainer')

                    // Create the category container
                    let category = generateFlexbox()
                        category.classList.add('item-desc')
                        category.innerHTML = `Category: ${itemObj.postCategory}`
                        category.classList.add('item-detail-cell')

                    // Create the container for comments
                    let inputContainer = document.createElement('div')
                        inputContainer.classList.add('postComment')
                        inputContainer.classList.add('announcement-postComment')
                        inputContainer.id = `${itemObj.postID}-post-container`
                    
                    // Create the input / text area
                    let input = document.createElement('textarea');
                        input.rows = '5'
                        input.cols = '75'
                        input.placeholder = 'Write a Comment...'
                        input.classList.add('commentInput')
                        input.id = `${itemObj.postID}-post-comment`

                    // Create the submit button
                    let inputButton = document.createElement('div');
                        inputButton.classList.add('commentSubmitButton');
                        inputButton.id = `${itemObj.postID}-post-button`
                        inputButton.innerHTML = 'Comment'

                    if (localStorage.getItem('pocDist') == 0){
                        input.style.display = "none";
                        inputButton.style.display = "none";
                    }
                    // When the submit button is clicked, submit the comment
                    inputButton.addEventListener('click', () => {
                        // Grab the input component
                        let input = document.getElementById(`${itemObj.postID}-post-comment`)
                        // Grab the input's value
                        let value = input.value
                        // Create the comment object
                        let postObj = {
                            user: localStorage.getItem("ownerid"),
                            
                            attachTo: itemObj.postID,
                            post: value,
                            isMod: localStorage.getItem("modDist")
                        }
                        // Send the comment to the server
                        $.ajax({
                            type: "GET",
                            url: '/api/postComment',
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            data: postObj,
                            success: function (msg) {
                                // On sucess, reload to update the UI
                                // Maybe create a way not to need to reload?
                                console.log('posted!')
                                location.reload()
                            },
                            error: function (e) {
                                console.log('failure')
                                console.log(e)
                            }
                        })

                    })
                    
                    // Create element where comments appear
                    let commentArea = document.createElement('div');
                        commentArea.classList.add('commentSection');
                        commentArea.classList.add('announcement-commentSection')
                        commentArea.id = `${itemObj.postID}-comment-section`

                    // Creates the button to remove posts
                    let modRemoveButton = document.createElement('div');
                        modRemoveButton.classList.add('removeButton');
                        modRemoveButton.id = `${itemObj.postID}-remove-button`
                        modRemoveButton.innerHTML = 'Mod Remove'

                        if (localStorage.getItem('modDist') == 0 || postID == 47) {
                            // hide mod remove button
                            modRemoveButton.style.display = "none";

                        } 
                        else {
                            modRemoveButton.addEventListener('click', () => {
                            let input = document.getElementById(`${itemObj.postID}-remove-comment`)

                            // let value = input.value

                            let dataObj = {
                                ID: itemObj.postID
                            }

                            $.ajax({
                                type: "GET",
                                url: '/api/mod-remove',
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: dataObj,
                                success: function (msg) {
                                    location.reload()
                                },
                                error: function (e) {
                                    console.log('failure')
                                    console.log(e)
                                }
                            })

                        })
                        }

                        // modRemoveButton.addEventListener('click', () => {
                        //     let input = document.getElementById(`${itemObj.postID}-remove-comment`)

                        //     // let value = input.value

                        //     let dataObj = {
                        //         ID: itemObj.postID
                        //     }

                        //     $.ajax({
                        //         type: "GET",
                        //         url: '/api/mod-remove',
                        //         contentType: "application/json; charset=utf-8",
                        //         dataType: "json",
                        //         data: dataObj,
                        //         success: function (msg) {
                        //             console.log('removed!')
                        //             location.reload()
                        //         },
                        //         error: function (e) {
                        //             console.log('failure')
                        //             console.log(e)
                        //         }
                        //     })

                        // })

                    // Start to create accordion arrow
                    let dropdownIcon = document.createElement('div');
                    dropdownIcon.classList.add('dropdown-icon')
                    
                    // Based on whether the arrow belongs to a comment or a post,
                    // assign the id.
                    if (itemObj.childOf) {
                        dropdownIcon.id = `${itemObj.postID}Chevron-t`
                    } else {
                        dropdownIcon.id = `${itemObj.postID}Chevron`
                    }

                    dropdownIcon.addEventListener('click', (e) => {
                        let targetId = e.target.id.split('C', 1)[0]
                        let childOfId = e.target.id.split('-', 2)[1]
                        if (childOfId) {
                            rotate(targetId, 1)
                        } else {
                            if (feedState.activeId === targetId) {
                                rotate(targetId)
                                feedState.activeId = null
                            } else if (feedState.activeId !== targetId && feedState.activeId !== null) {
                                rotate(feedState.activeId)
                                rotate(targetId)
                                feedState.activeId = targetId
                            } else if (feedState.activeId === null) {
                                rotate(targetId)
                                feedState.activeId = targetId
                            }
                        }
                    })

                /// Start to attach elements to each other (note that the order is specific)
                    arrowContainer.appendChild(upArrow)
                    arrowContainer.appendChild(downArrow)
                    // If childOf is "Truthy", we do not want to add a category
                    if (!childOf) {
                        arrowContainer.appendChild(category)  
                    }

                    inputContainer.appendChild(input)
                    inputContainer.appendChild(inputButton)
                    inputContainer.appendChild(modRemoveButton)
                    
                    commentArea.appendChild(inputContainer)
                    
                    innerDetails.appendChild(commentArea)  
                    
                    details.appendChild(header)
                    details.appendChild(arrowContainer)
                    details.appendChild(innerDetails)

                    itemContainer.appendChild(details)
                    itemContainer.appendChild(dropdownIcon)
                    
                    // Append item to a specific container depend on whether it is a post or a comment
                    if (!childOf) {
                        listContainer.appendChild(itemContainer)
                    } else {
                        try {
                            document.getElementById(`${childOf}-comment-section`).appendChild(itemContainer)
                        }
                        catch (err) { console.log("Error adding comment.");}
                    }
                } else {
                    // Grab the feed container
                    let listContainer = document.querySelector('.listContainer')
                    
                    // Make the item container
                    let itemContainer = generateFlexbox()
                    itemContainer.classList.add('item-container')
                    itemContainer.id = itemObj.postID

                    console.log(itemObj)
                    if (itemObj.isMod === 1 || itemObj.modHasCommented === 1) {
                        console.log('inside')
                        itemContainer.classList.add('blue');
                    }

                    // Create the header of the post
                    let header = generateFlexbox()
                    header.innerHTML = itemObj.postContent
                    header.classList.add('item-header')

                    // Create the body of the post
                    let details = document.createElement('div')
                    details.classList.add('flex')
                    details.classList.add('flex-column')
                    details.classList.add('item-details')

                    // Create the hidden part of the post
                    let innerDetails = generateFlexbox()
                    innerDetails.classList.add('item-inner-details')
                    innerDetails.id = `${itemObj.postID}InnerDetails`
                    // Hide it
                    innerDetails.classList.add('hidden')

                    // Create the upvote arrow
                    let upArrow = generateFlexbox()
                        // This is the actual arrow icon
                        upArrow.innerHTML = `<img src='./assets/white-up.png' class='v-icon' id='up-v-icon' alt='upvote'/><div class='count' id='ua_${itemObj.postID}'>${itemObj.voteCount}</div>`
                        upArrow.classList.add('up-arrow')
                        upArrow.classList.add('arrow')

                        // Remember when we grabbed the items the user has voted on?
                        // This uses that data to check if this is one of those items
                        if (feedState.votedItems) {
                            let post_id = `p${itemObj.postID}`
                            // If the user has upvoted this before, add the voted class
                            if (feedState.votedItems[post_id]) {
                                if (feedState.votedItems[post_id].up_or_down === "up") {
                                    upArrow.classList.add('voted')
                                }
                            }
                        }

                        // Event listener that handles the upvote click
                        upArrow.addEventListener("click", () => {

                            // Get the current count
                            let currentCount = itemObj.voteCount
                            // We update may update the UI so the upvote count does not match the state
                            // If this is the case, trust the UI and not the state
                            if (Number(currentCount) !== Number(document.getElementById(`ua_${itemObj.postID}`).innerHTML)){
                                currentCount = document.getElementById(`ua_${itemObj.postID}`).innerHTML;
                            }
                            
                            // Create the item we are pushing to the server
                            let postDetails = {
                                postId: itemObj.postID,
                                userId: localStorage.getItem("ownerid"),
                                itemCount: currentCount,
                            }

                            // The arrow will have the "voted" class if the user has already voted
                            // If this is the class, remove the upvote
                            if (upArrow.classList.contains('voted')) {

                                // Reduce votecount by 1
                                $.ajax({
                                    type: "GET",
                                    url: '/api/upvote-reset',
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    data: postDetails,
                                    success: function (msg) {
                                        // On success, update UI
                                        upArrow.classList.remove('voted')
                                        document.getElementById(`ua_${itemObj.postID}`).innerHTML = msg.count;

                                        // Update state
                                        updateCount('up', 'del', itemObj.postID)
                                    },
                                    error: function (e) {
                                        console.log('failure')
                                        console.log(e)
                                    }
                                })
                            } else {
                                // If the user has not upvoted yet, send the update to the server
                                $.ajax({
                                    type: "GET",
                                    url: '/api/upvote',
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    data: postDetails,
                                    success: function (msg) {
                                        // On success, add points
                                        addEmployeePoints(1, posterId);

                                        // Update UI
                                        upArrow.classList.add('voted')
                                        document.getElementById(`ua_${itemObj.postID}`).innerHTML = msg.count;

                                        // Update state
                                        updateCount('up', 'add', itemObj.postID)
                                    },
                                    error: function (e) {
                                        console.log('failure')
                                        console.log(e)
                                    }
                                })
                            }
                        })

                    // Literally the exact smae as the upvote, just for downvoting.
                    // Maybe those functions should have been combined?
                    let downArrow = generateFlexbox()
                        downArrow.innerHTML = `<img src='./assets/white-up.png' class='v-icon' id='down-v-icon' alt='downvote'/><div class='count' id='da_${itemObj.postID}'>${itemObj.downVoteCount}</div>`
                        downArrow.classList.add('down-arrow')
                        downArrow.classList.add('arrow')

                        if (feedState.votedItems) {
                            let post_id = `p${itemObj.postID}`

                            if (feedState.votedItems[post_id]) {
                                if (feedState.votedItems[post_id].up_or_down === "down") {
                                    downArrow.classList.add('voted')
                                }
                            }
                        }

                    downArrow.addEventListener("click", () => {

                        let currentDownCount = itemObj.downVoteCount

                        if (Number(currentDownCount) !== Number(document.getElementById(`da_${itemObj.postID}`).innerHTML)){
                            currentDownCount = document.getElementById(`da_${itemObj.postID}`).innerHTML;
                        }

                        let postDetails = {
                            postId: itemObj.postID,
                            userId: 1,
                            itemCount: currentDownCount,
                        }

                        if (downArrow.classList.contains('voted')) {
                            $.ajax({
                                type: "GET",
                                url: '/api/downvote-reset',
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: postDetails,
                                success: function (msg) {
                                    downArrow.classList.remove('voted')
                                    document.getElementById(`da_${itemObj.postID}`).innerHTML = msg.count;
                                    updateCount('down', 'del', itemObj.postID)
                                },
                                error: function (e) {
                                    console.log('failure')
                                    console.log(e)
                                }
                            })
                        } else {
                            $.ajax({
                                type: "GET",
                                url: '/api/downvote',
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: postDetails,
                                success: function (msg) {
                                    downArrow.classList.add('voted')
                                    document.getElementById(`da_${itemObj.postID}`).innerHTML = msg.count;
                                    updateCount('down', 'add', itemObj.postID)
                                },
                                error: function (e) {
                                    console.log('failure')
                                    console.log(e)
                                }
                            })
                        }
                    })

                    // Create the home for the arrows
                    let arrowContainer = document.createElement('div')
                        arrowContainer.classList.add('arrowContainer')

                    // Create the category container
                    let category = generateFlexbox()
                        category.classList.add('item-desc')
                        category.innerHTML = `Category: ${itemObj.postCategory}`
                        category.classList.add('item-detail-cell')

                    // Create the container for comments
                    let inputContainer = document.createElement('div')
                        inputContainer.classList.add('postComment')
                        inputContainer.id = `${itemObj.postID}-post-container`
                    
                    // Create the input / text area
                    let input = document.createElement('textarea');
                        input.rows = '3'
                        input.cols = '75'
                        input.placeholder = 'Write a Comment...'
                        input.classList.add('commentInput')
                        input.id = `${itemObj.postID}-post-comment`

                    // Create the submit button
                    let inputButton = document.createElement('div');
                        inputButton.classList.add('commentSubmitButton');
                        inputButton.id = `${itemObj.postID}-post-button`
                        inputButton.innerHTML = 'Comment'

                    // When the submit button is clicked, submit the comment
                    inputButton.addEventListener('click', () => {
                        // Grab the input component
                        let input = document.getElementById(`${itemObj.postID}-post-comment`)
                        // Grab the input's value
                        let value = input.value
                        // Create the comment object
                        let dataObj = {
                            user: localStorage.getItem("ownerid"),
                            attachTo: itemObj.postID,
                            post: value,
                            isMod: localStorage.getItem('modDist'),
                        }
                        // Send the comment to the server
                        $.ajax({
                            type: "GET",
                            url: '/api/postComment',
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            data: dataObj,
                            success: function (msg) {
                                // On sucess, reload to update the UI
                                // Maybe create a way not to need to reload?
                                console.log('posted!')
                                location.reload()
                            },
                            error: function (e) {
                                console.log('failure')
                                console.log(e)
                            }
                        })

                    })
                    
                    // Create element where comments appear
                    let commentArea = document.createElement('div');
                        commentArea.classList.add('commentSection');
                        commentArea.id = `${itemObj.postID}-comment-section`

                    // Creates the button to remove posts
                    let modRemoveButton = document.createElement('div');
                        modRemoveButton.classList.add('removeButton');
                        modRemoveButton.id = `${itemObj.postID}-remove-button`
                        modRemoveButton.innerHTML = 'Mod Remove'

                        if (localStorage.getItem('modDist') == 0) {
                            // hide mod remove button
                            modRemoveButton.style.display = "none";

                        } 
                        else {
                            modRemoveButton.addEventListener('click', () => {
                            let input = document.getElementById(`${itemObj.postID}-remove-comment`)

                            // let value = input.value

                            let dataObj = {
                                ID: itemObj.postID
                            }

                            $.ajax({
                                type: "GET",
                                url: '/api/mod-remove',
                                contentType: "application/json; charset=utf-8",
                                dataType: "json",
                                data: dataObj,
                                success: function (msg) {
                                    location.reload()
                                },
                                error: function (e) {
                                    console.log('failure')
                                    console.log(e)
                                }
                            })

                        })
                        }

                        // modRemoveButton.addEventListener('click', () => {
                        //     let input = document.getElementById(`${itemObj.postID}-remove-comment`)

                        //     // let value = input.value

                        //     let dataObj = {
                        //         ID: itemObj.postID
                        //     }

                        //     $.ajax({
                        //         type: "GET",
                        //         url: '/api/mod-remove',
                        //         contentType: "application/json; charset=utf-8",
                        //         dataType: "json",
                        //         data: dataObj,
                        //         success: function (msg) {
                        //             console.log('removed!')
                        //             location.reload()
                        //         },
                        //         error: function (e) {
                        //             console.log('failure')
                        //             console.log(e)
                        //         }
                        //     })

                        // })

                    // Start to create accordion arrow
                    let dropdownIcon = document.createElement('div');
                    dropdownIcon.classList.add('dropdown-icon')
                    
                    // Based on whether the arrow belongs to a comment or a post,
                    // assign the id.
                    if (itemObj.childOf) {
                        dropdownIcon.id = `${itemObj.postID}Chevron-t`
                    } else {
                        dropdownIcon.id = `${itemObj.postID}Chevron`
                    }

                    dropdownIcon.addEventListener('click', (e) => {
                        let targetId = e.target.id.split('C', 1)[0]
                        let childOfId = e.target.id.split('-', 2)[1]
                        if (childOfId) {
                            rotate(targetId, 1)
                        } else {
                            if (feedState.activeId === targetId) {
                                rotate(targetId)
                                feedState.activeId = null
                            } else if (feedState.activeId !== targetId && feedState.activeId !== null) {
                                rotate(feedState.activeId)
                                rotate(targetId)
                                feedState.activeId = targetId
                            } else if (feedState.activeId === null) {
                                rotate(targetId)
                                feedState.activeId = targetId
                            }
                        }
                    })

                // Create progress / mod status area
                    // Create the containers
                let progressContainer = document.createElement('div')
                    progressContainer.classList.add('progressContainer')

                let progressInfo = document.createElement('div')
                    progressInfo.classList.add('progressInfo')
                
                // If the user is a mod, we want to show radio buttons
                // Otherwise, just show the status
                if (Number(localStorage.getItem('modDist'))) {

                    // Possible statuses
                    let options = ['In Progress', 'Need More Information', 'Not Currently Feasible', 'On Hold']

                    // For each status option, create an input area
                    options.forEach((option) => {

                        // input container
                        let radioContainer = document.createElement('radioContainer')
                            radioContainer.id = `${itemObj.postID}-radio-container`
                            radioContainer.classList.add('radio-container')
                        
                        // radio butt
                        let inputRadio = document.createElement('input')
                            inputRadio.id = `${itemObj.postID}-radio-input`
                            inputRadio.classList.add('statusInput')
                            inputRadio.name = `statusInput-${itemObj.postID}`
                            inputRadio.type = 'radio'
                            inputRadio.value = option

                            // if this is the current status, check it
                            if (itemObj.status === option) {
                                inputRadio.checked = true
                            }

                            // on change, update the database
                            inputRadio.addEventListener('change', (e) => {
                                let dataObj = {
                                    value: option,
                                    id: itemObj.postID,
                                }

                                $.ajax({
                                    type: "GET",
                                    url: '/api/update-status',
                                    contentType: "application/json; charset=utf-8",
                                    dataType: "json",
                                    data: dataObj,
                                    success: function (msg) {
                                        console.log('updated')
                                    },
                                    error: function (e) {
                                        console.log('failure')
                                        console.log(e)
                                    }
                                })
                            })

                        let label = document.createElement('label')
                            label.for = `${itemObj.postID}-radio-input`
                            label.innerHTML = option

                        // attach the components
                        radioContainer.appendChild(inputRadio)
                        radioContainer.appendChild(label)

                        progressInfo.appendChild(radioContainer)
                    })
                
                // If the user is not a mod, just show status
                } else {
                    if (itemObj.status) {
                        progressContainer.innerHTML = `${itemObj.status}`
                        progressContainer.classList.add('non-mod')
                    }
                }

                /// Start to attach elements to each other (note that the order is specific)
                    arrowContainer.appendChild(upArrow)
                    arrowContainer.appendChild(downArrow)
                    // If childOf is "Truthy", we do not want to add a category
                    if (!childOf) {
                        arrowContainer.appendChild(category)  
                    }

                    inputContainer.appendChild(input)
                    inputContainer.appendChild(inputButton)
                    inputContainer.appendChild(modRemoveButton)
                    
                    commentArea.appendChild(inputContainer)
                    
                    innerDetails.appendChild(commentArea)  

                    progressContainer.appendChild(progressInfo)
                    
                    details.appendChild(header)
                    if (!childOf) {
                        details.appendChild(progressContainer) 
                    }

                    details.appendChild(arrowContainer)
                    details.appendChild(innerDetails)

                    itemContainer.appendChild(details)
                    itemContainer.appendChild(dropdownIcon)
                    
                    // Append item to a specific container depend on whether it is a post or a comment
                    if (!childOf) {
                        listContainer.appendChild(itemContainer)
                    } else {
                        try {
                            document.getElementById(`${childOf}-comment-section`).appendChild(itemContainer)
                        }
                        catch (err) {
                            console.log("Comment didn't post.");
                        }
                    }
                }

            } // Added to the UI!

            // Utility function that updates the state vote count
            function updateCount(countType, addOrDel, id) { 
                for (let i = 0; i < feedState.items.length; i++) {
                    if (feedState.items[i].postID === id) {
                        console.log('item', feedState.items[i], 'c', countType, 'addD', addOrDel)
                        if (countType === 'up') {
                            if (addOrDel === 'add') {
                                feedState.items[i].voteCount = feedState.items[i].voteCount + 1
                            } else {
                                feedState.items[i].voteCount = feedState.items[i].voteCount - 1
                            }
                        } else {
                            if (addOrDel === 'add') {
                                feedState.items[i].downVoteCount = feedState.items[i].voteCount + 1
                            } else {
                                feedState.items[i].downVoteCount = feedState.items[i].voteCount - 1
                            }
                        }
                    }
                }
            }
            
            // Function that handles initing the feed page
            function initFeed() {
                // Create and show loader
                let loader = document.createElement('img')
                        loader.src = './assets/91.svg'
                        loader.id = 'loader'
                        document.querySelector('.listContainer').appendChild(loader)
                getItems()
            }

            // Init all global JavaScript
            init()

            // Init all feed JavaScript
            initFeed()
        </script>
    </body>
</html>